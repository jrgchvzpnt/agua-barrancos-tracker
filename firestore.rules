rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isAdmin() {
      // Checks if the user's UID exists in the 'admins' collection. Secure.
      return exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function isPublicRead() {
      // Allow public read access.
      return request.auth == null || request.auth != null;
    }

    // --- Collection Rules ---

    // Admin Collection: Secure
    // A user can read their own admin status. Client-side writes are disabled.
    match /admins/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Prevent client-side modification of admins
    }

    // Outages Collection: Secured
    match /outages/{outageId} {
      allow read: if isPublicRead();
      allow write: if isAdmin() &&
                      // Validate document ID format (YYYY-MM-DD)
                      outageId.matches('^\\d{4}-\\d{2}-\\d{2}$') &&
                      // Enforce strict data schema
                      request.resource.data.keys().hasOnly(['status', 'notes', 'duracion', 'timestamp']) &&
                      // Validate field types and constraints
                      request.resource.data.status is string &&
                      request.resource.data.status.size() < 100 &&
                      request.resource.data.notes is string &&
                      request.resource.data.notes.size() < 500 &&
                      request.resource.data.duracion is string &&
                      request.resource.data.duracion.size() < 50 &&
                      request.resource.data.timestamp is timestamp; // Use proper timestamp
    }

    // Messages Collection: Secured
    match /messages/{messageId} {
      allow read, delete: if isAdmin();
      // Allow creation only with a strict schema and size limits to prevent abuse
      allow create: if request.resource.data.keys().hasOnly(['name', 'phone', 'message', 'createdAt']) &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 1 && request.resource.data.name.size() < 100 &&
                       request.resource.data.phone is string &&
                       request.resource.data.phone.size() > 1 && request.resource.data.phone.size() < 100 &&
                       request.resource.data.message is string &&
                       request.resource.data.message.size() > 1 && request.resource.data.message.size() < 1000 &&
                       request.resource.data.createdAt is timestamp;
    }

    // Ads Collection: Secured
    match /ads/{adId} {
      allow read: if isPublicRead();
      allow write: if isAdmin() &&
                      // Enforce strict data schema, now including imageDescriptions
                      request.resource.data.keys().hasOnly(['name', 'imageUrls', 'imageDescriptions', 'linkUrl', 'createdAt']) &&
                      // Validate field types and constraints
                      request.resource.data.name is string &&
                      request.resource.data.name.size() < 100 &&
                      request.resource.data.linkUrl is string &&
                      request.resource.data.linkUrl.size() < 500 &&
                      request.resource.data.imageUrls is list &&
                      request.resource.data.imageUrls.size() < 10 && // Limit to 10 images
                      request.resource.data.imageDescriptions is list &&
                      request.resource.data.imageDescriptions.size() < 10 && // Match image count
                      request.resource.data.createdAt is timestamp;
    }

    // Analytics Collection: Secured
    match /analytics/{docId} {
      allow read: if isAdmin();
      // Allow anyone to create or update, but only to increment the visit count.
      // This prevents a malicious user from setting an arbitrary number of visits.
      allow write: if (
        // Validate document ID format
        (docId.matches('^Y_\\d{4}$') || docId.matches('^M_\\d{4}_\\d{2}$') || docId.matches('^D_\\d{4}_\\d{2}_\\d{2}$')) &&
        // Enforce schema: only a 'visits' field of type number is allowed
        request.resource.data.keys().hasOnly(['visits']) &&
        request.resource.data.visits is number &&
        (
          // On create, the value must be 1
          (resource == null && request.resource.data.visits == 1) ||
          // On update, the new value must be exactly 1 greater than the old one
          (resource != null && request.resource.data.visits == resource.data.visits + 1)
        )
      );
    }
  }
}
